# Anomaly Rate Metric
#
# Computes the rate of anomalies/outliers in the dataset.
# Combines statistical outliers and Benford's Law violations.

graph_id: "anomaly_rate"
graph_type: "metric"
version: "1.0"

# Scope: computed at both global and per-slice levels
scope: "both"
slice_dimension: null  # Set dynamically based on slicing agent recommendations

metadata:
  name: "Anomaly Rate"
  description: "Percentage of data points flagged as anomalous"
  category: "quality"
  source: "system"
  tags: ["quality", "anomaly", "outliers", "benford"]

output:
  type: "scalar"
  metric_id: "anomaly_rate"
  unit: "percentage"
  decimal_places: 2

interpretation:
  ranges:
    - min_value: 0.0
      max_value: 1.0
      label: "normal"
      description: "Anomaly rate within expected bounds"
    - min_value: 1.0
      max_value: 5.0
      label: "elevated"
      description: "Higher than typical anomaly rate, worth investigating"
    - min_value: 5.0
      max_value: 10.0
      label: "high"
      description: "Significant anomaly rate indicating potential data issues"
    - min_value: 10.0
      max_value: 100.0
      label: "critical"
      description: "Excessive anomalies suggesting systematic data quality problems"

dependencies:
  # Extract outlier counts from statistical profiles
  outlier_count:
    level: 1
    type: "extract"
    source:
      table: "statistical_profiles"
      column: "outlier_count"
      filter: "table_id IN (:table_ids)"
    aggregation: "sum"

  # Extract total row counts
  total_count:
    level: 1
    type: "extract"
    source:
      table: "statistical_profiles"
      column: "total_count"
      filter: "table_id IN (:table_ids)"
    aggregation: "sum"

  # Extract Benford anomalies (optional, may not exist for all columns)
  benford_violations:
    level: 1
    type: "extract"
    source:
      table: "statistical_profiles"
      column: "benford_anomalous"
      filter: "table_id IN (:table_ids)"
    aggregation: "sum"
    # Returns count of columns flagged as Benford anomalous

  # Calculate outlier rate
  outlier_rate:
    level: 2
    type: "formula"
    expression: "outlier_count / NULLIF(total_count, 0) * 100"
    depends_on: ["outlier_count", "total_count"]

  # Calculate combined anomaly rate
  # Outlier rate + penalty for Benford violations
  anomaly_rate:
    level: 3
    type: "formula"
    expression: "outlier_rate + (CASE WHEN benford_violations > 0 THEN 2.0 ELSE 0 END)"
    depends_on: ["outlier_rate", "benford_violations"]
    output_step: true
