# Pattern-Based Quality Rules
#
# These filter graphs apply to columns based on their name patterns.
# Each graph targets columns matching a regex pattern.

---
# Email column checks
graph_id: "pattern_email_checks"
graph_type: "filter"
version: "1.0"

metadata:
  name: "Email Column Quality"
  description: "Quality rules for email columns"
  category: "quality"
  source: "system"
  tags: ["pattern-based", "email", "format"]
  applies_to:
    column_pattern: ".*_email$|^email$|.*email.*"

output:
  type: "classification"
  categories:
    clean: "Email column passes format check"
    flag: "Email column has invalid formats"

dependencies:
  valid_email:
    level: 1
    type: "predicate"
    condition: "regexp_matches({column}, '^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$') OR {column} IS NULL OR {column} = ''"
    on_false: "flag"
    reason: "Email columns should contain valid email addresses"
    severity: "medium"

  email_clean:
    level: 2
    type: "composite"
    logic: "valid_email"
    depends_on: ["valid_email"]
    output_step: true

---
# URL column checks
graph_id: "pattern_url_checks"
graph_type: "filter"
version: "1.0"

metadata:
  name: "URL Column Quality"
  description: "Quality rules for URL columns"
  category: "quality"
  source: "system"
  tags: ["pattern-based", "url", "format"]
  applies_to:
    column_pattern: ".*_url$|^url$|.*_link$|^link$|.*website.*"

output:
  type: "classification"
  categories:
    clean: "URL column passes format check"
    flag: "URL column has invalid formats"

dependencies:
  valid_url:
    level: 1
    type: "predicate"
    condition: "regexp_matches({column}, '^https?://[^\\s]+$') OR {column} IS NULL OR {column} = ''"
    on_false: "flag"
    reason: "URL columns should contain valid URLs"
    severity: "medium"

  url_clean:
    level: 2
    type: "composite"
    logic: "valid_url"
    depends_on: ["valid_url"]
    output_step: true

---
# Phone column checks
graph_id: "pattern_phone_checks"
graph_type: "filter"
version: "1.0"

metadata:
  name: "Phone Column Quality"
  description: "Quality rules for phone number columns"
  category: "quality"
  source: "system"
  tags: ["pattern-based", "phone", "format"]
  applies_to:
    column_pattern: ".*_phone.*|^phone$|.*telephone.*|.*mobile.*|.*cell.*"

output:
  type: "classification"
  categories:
    clean: "Phone column passes format check"
    flag: "Phone column has invalid formats"

dependencies:
  valid_phone:
    level: 1
    type: "predicate"
    # Matches common phone formats: +1234567890, (123) 456-7890, 123-456-7890, etc.
    condition: "regexp_matches({column}, '^[\\+]?[0-9()\\-\\s\\.]{7,20}$') OR {column} IS NULL OR {column} = ''"
    on_false: "flag"
    reason: "Phone columns should contain valid phone numbers"
    severity: "low"

  phone_clean:
    level: 2
    type: "composite"
    logic: "valid_phone"
    depends_on: ["valid_phone"]
    output_step: true
