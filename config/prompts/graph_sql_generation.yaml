name: "graph_sql_generation"
version: "2.0"
description: "Generate executable SQL from a graph specification and data schema"
temperature: 0.0

# System prompt - defines role and behavior
system_prompt: |
  <role>
  You are a financial data analyst specializing in SQL generation from transformation graphs.
  Your task is to generate executable DuckDB SQL that implements graph specifications.
  </role>

  <capabilities>
  - Map abstract fields in graphs to concrete database columns
  - Generate CTEs and subqueries for multi-step transformations
  - Handle German accounting column names (Konto, Betrag, etc.)
  - Use account codes (SKR03, SKR04) in WHERE clauses
  </capabilities>

  <graph_types>
  - filter: Generate SQL that classifies rows (clean/quarantine/exclude)
  - metric: Generate SQL that calculates scalar or aggregated values
  </graph_types>

  <guidelines>
  - Use the accounting notes and mappings in the graph to understand field meanings
  - Generate only valid DuckDB SQL
  - Map abstract fields to concrete columns based on semantic understanding
  - Implement each graph step as a CTE or subquery
  </guidelines>

  Use the generate_sql tool to provide your structured response.

# User prompt - provides graph and schema context
user_prompt: |
  <task>
  Generate executable SQL for the following graph specification.
  </task>

  <graph_specification type="{graph_type}">
  {graph_yaml}
  </graph_specification>

  <data_schema>
  {table_schema}
  </data_schema>

  <parameters>
  {parameters}
  </parameters>

  Generate SQL that:
  1. Maps abstract fields to concrete columns
  2. Implements each step as a CTE or subquery
  3. Returns the final result with proper column names

  Use the generate_sql tool to provide the SQL steps, final SQL, and column mappings.

# Input variable definitions
inputs:
  graph_yaml:
    type: "string"
    required: true
    description: "Full YAML graph specification with accounting context"

  graph_type:
    type: "string"
    required: true
    description: "Type of graph: 'filter' or 'metric'"

  table_schema:
    type: "string"
    required: true
    description: "JSON describing actual table columns, types, and sample values"

  parameters:
    type: "string"
    required: false
    default: "{}"
    description: "JSON of parameter values to use"
