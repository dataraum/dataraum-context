name: "graph_sql_generation"
version: "1.0"
description: "Generate executable SQL from a graph specification and data schema"
temperature: 0.0

inputs:
  graph_yaml:
    type: "string"
    required: true
    description: "Full YAML graph specification with accounting context"

  graph_type:
    type: "string"
    required: true
    description: "Type of graph: 'filter' or 'metric'"

  table_schema:
    type: "string"
    required: true
    description: "JSON describing actual table columns, types, and sample values"

  parameters:
    type: "string"
    required: false
    default: "{}"
    description: "JSON of parameter values to use"

prompt: |
  You are a financial data analyst tasked with generating executable SQL from a graph specification.

  ## Graph Specification

  The following YAML defines WHAT to calculate, with rich accounting context:

  ```yaml
  {graph_yaml}
  ```

  ## Graph Type

  This is a **{graph_type}** graph.

  ## Actual Data Schema

  The data is in a DuckDB database with the following schema:

  ```json
  {table_schema}
  ```

  ## Parameters

  Use these parameter values:
  ```json
  {parameters}
  ```

  ## Your Task

  Generate executable SQL that:
  1. Maps the abstract fields in the graph to concrete columns in the schema
  2. Implements each step of the graph as a CTE or subquery
  3. Returns the final result with proper column names

  For **filter graphs**: Generate SQL that classifies rows (clean/quarantine/exclude)
  For **metric graphs**: Generate SQL that calculates the metric value

  ## Important

  - Use the accounting notes and mappings in the graph to understand what each field means
  - If the data has German column names (Konto, Betrag, etc.), map them correctly
  - If account codes are mentioned (e.g., SKR03: 1200, 1400), use them in WHERE clauses
  - Return ONLY valid DuckDB SQL, no explanations

  ## Output Format

  Return a JSON object with:
  ```json
  {{
    "steps": [
      {{
        "step_id": "step_name",
        "sql": "SELECT ... FROM ...",
        "description": "What this step does"
      }}
    ],
    "final_sql": "The complete SQL that produces the final result",
    "column_mappings": {{
      "abstract_field": "concrete_column"
    }}
  }}
  ```

output_schema:
  type: "object"
  properties:
    steps:
      type: "array"
      items:
        type: "object"
        properties:
          step_id:
            type: "string"
          sql:
            type: "string"
          description:
            type: "string"
    final_sql:
      type: "string"
    column_mappings:
      type: "object"

validation:
  required_fields:
    - "steps"
    - "final_sql"
    - "column_mappings"
