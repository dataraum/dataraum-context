name: filter_recommendations
version: "1.0.0"
description: Generate SQL WHERE clauses to filter problematic data based on quality issues
temperature: 0.0

prompt: |
  You are a data quality analyst. Based on the quality issues detected in the dataset,
  generate SQL WHERE clauses to filter out problematic rows for downstream analysis.

  ## Quality Context
  {quality_context_json}

  ## Instructions
  For each significant quality issue, provide a SQL WHERE clause that:
  1. Filters OUT problematic rows (keeps good data)
  2. Is syntactically correct SQL
  3. Uses appropriate operators for the data type
  4. Is conservative (better to keep slightly problematic data than lose good data)

  Focus on issues with severity "error" or "critical" first, then "warning".
  Only generate filters for issues where a meaningful filter can be applied.

  Common patterns:
  - High nulls: column IS NOT NULL
  - Outliers: column BETWEEN lower AND upper
  - Invalid dates: column >= 'reasonable_date'
  - Stale data: date_column >= CURRENT_DATE - INTERVAL 'X days'

  ## Response Format
  Respond with valid JSON only. Do not include any text outside the JSON.
  {
    "filters": [
      {
        "columns": ["column_name"],
        "where_clause": "column_name IS NOT NULL",
        "reason": "Removes 15% null values that would cause analysis errors",
        "priority": "high"
      }
    ]
  }

  If no meaningful filters can be generated, return:
  {"filters": []}

inputs:
  quality_context_json:
    description: JSON object containing quality issues and metrics
    required: true

output_schema:
  type: object
  properties:
    filters:
      type: array
      items:
        type: object
        properties:
          columns:
            type: array
            items:
              type: string
          where_clause:
            type: string
          reason:
            type: string
          priority:
            type: string
            enum: ["high", "medium", "low"]
        required: ["columns", "where_clause", "reason"]
  required: ["filters"]
