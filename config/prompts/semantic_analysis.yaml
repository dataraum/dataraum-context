# Semantic Analysis Prompt
#
# Analyzes table and column semantics across the entire schema.
# Customize this prompt to match your domain or existing prompt libraries.

name: semantic_analysis
version: "1.0.0"
description: Analyze table and column semantics for AI-driven analytics

# Temperature (0.0 = deterministic, 1.0 = creative)
temperature: 0.0

# The prompt template
# Available variables: {tables_json}, {ontology_name}, {ontology_concepts}, {relationship_candidates}
prompt: |
  You are a data analyst examining a database schema. Your task is to analyze the semantic meaning of each table and column to enable AI-driven data analytics.

  ## Schema to Analyze

  {tables_json}

  ## Target Ontology: {ontology_name}

  Map columns to these domain concepts where applicable:
  {ontology_concepts}

  ## Pre-computed Relationship Candidates

  The following relationship candidates were detected by analyzing actual data values.
  Each candidate shows the value overlap score (1.0 = perfect containment or match).

  {relationship_candidates}

  **Your task**: Evaluate each candidate and determine:
  - Is this a real foreign key relationship? (e.g., customer_id â†’ customers.id)
  - Is this shared reference data? (e.g., both tables have US state codes)
  - Is this coincidental overlap? (e.g., row IDs happen to overlap with business IDs)

  Not all candidates are real relationships. Use column names and semantic context to decide.

  ## Analysis Instructions

  For each **table**, determine:
  - **entity_type**: What real-world entity does this table represent?
  - **description**: One sentence describing the table's purpose
  - **is_fact_table**: Is this a fact table (transactions/events) or dimension table?
  - **grain**: Which column(s) define the unique grain of the table?
  - **time_column**: Primary timestamp column, if any

  For each **column**, determine:
  - **semantic_role**: One of: measure, dimension, key, foreign_key, timestamp, attribute
  - **entity_type**: What does this column represent? (customer_id, product_name, etc.)
  - **business_term**: Map to ontology concept if applicable, otherwise suggest one
  - **description**: One sentence human-readable description
  - **confidence**: Your confidence in this analysis (0.0-1.0)

  For **relationships**, evaluate the pre-computed candidates above and:
  - **Confirm real FKs**: Candidates where column names indicate a key reference
  - **Mark shared data**: Candidates that are lookup/reference values (states, codes)
  - **Reject coincidental**: Candidates with no semantic connection
  - **Add missing**: Any relationships you detect that weren't in the candidates

  ## Semantic Role Definitions

  - **key**: Primary identifier for the table (usually unique, non-null)
  - **foreign_key**: References another table's key
  - **measure**: Numeric value that can be aggregated (summed, averaged)
  - **dimension**: Categorical attribute for grouping/filtering
  - **timestamp**: Date or datetime for time-based analysis
  - **attribute**: Descriptive field, not typically used for aggregation or grouping

  ## Response Format

  Respond with valid JSON only, no markdown formatting:

  {{
    "tables": [
      {{
        "table_name": "...",
        "entity_type": "...",
        "description": "...",
        "is_fact_table": true,
        "grain": ["col1"],
        "time_column": "created_at",
        "columns": [
          {{
            "column_name": "...",
            "semantic_role": "key|foreign_key|measure|dimension|timestamp|attribute",
            "entity_type": "...",
            "business_term": "...",
            "description": "...",
            "confidence": 0.95
          }}
        ]
      }}
    ],
    "relationships": [
      {{
        "from_table": "transactions",
        "from_column": "customer_id",
        "to_table": "customers",
        "to_column": "id",
        "relationship_type": "foreign_key",
        "cardinality": "many_to_one",
        "confidence": 0.95,
        "reasoning": "customer_id in transactions references customers.id primary key"
      }}
    ],
    "summary": "Brief overview of the schema structure and domain"
  }}

# Input variable definitions
inputs:
  tables_json:
    description: JSON array of tables with columns and statistics
    required: true

  ontology_name:
    description: Name of the target ontology
    required: true
    default: "general"

  ontology_concepts:
    description: List of concepts from the ontology
    required: false
    default: "No specific ontology concepts defined"

  relationship_candidates:
    description: Pre-computed relationship candidates from TDA and join detection
    required: false
    default: "No pre-computed relationship candidates available."

# Expected output schema (for validation)
output_schema:
  type: object
  required:
    - tables
  properties:
    tables:
      type: array
      items:
        type: object
        required:
          - table_name
          - columns
    relationships:
      type: array
    summary:
      type: string

# Validation rules
validation:
  semantic_role_values:
    - measure
    - dimension
    - key
    - foreign_key
    - timestamp
    - attribute
  relationship_types:
    - foreign_key
    - hierarchy
  cardinality_values:
    - one_to_one
    - one_to_many
    - many_to_one
    - many_to_many
