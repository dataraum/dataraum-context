# Semantic Analysis Prompt
#
# Analyzes table and column semantics across the entire schema.
# Customize this prompt to match your domain or existing prompt libraries.

name: semantic_analysis
version: "1.0.0"
description: Analyze table and column semantics for AI-driven analytics

# Temperature (0.0 = deterministic, 1.0 = creative)
temperature: 0.0

# The prompt template
# Available variables: {tables_json}, {ontology_name}, {ontology_concepts}
prompt: |
  You are a data analyst examining a database schema. Your task is to analyze the semantic meaning of each table and column to enable AI-driven data analytics.

  ## Schema to Analyze

  {tables_json}

  ## Target Ontology: {ontology_name}

  Map columns to these domain concepts where applicable:
  {ontology_concepts}

  ## Analysis Instructions

  For each **table**, determine:
  - **entity_type**: What real-world entity does this table represent?
  - **description**: One sentence describing the table's purpose
  - **is_fact_table**: Is this a fact table (transactions/events) or dimension table?
  - **grain**: Which column(s) define the unique grain of the table?
  - **time_column**: Primary timestamp column, if any

  For each **column**, determine:
  - **semantic_role**: One of: measure, dimension, key, foreign_key, timestamp, attribute
  - **entity_type**: What does this column represent? (customer_id, product_name, etc.)
  - **business_term**: Map to ontology concept if applicable, otherwise suggest one
  - **description**: One sentence human-readable description
  - **confidence**: Your confidence in this analysis (0.0-1.0)

  For **relationships**, identify ALL possible relationships between tables:
  - **Foreign key relationships**: Look for columns that reference keys in other tables
    * Match on naming patterns (customer_id → customers.id, vendor_id → vendors.id)
    * Match on semantic meaning (txn_customer → customers.customer_id)
    * Consider cardinality based on distinct counts
  - **Hierarchical relationships**: Parent-child structures (product → category)
  - **Business process flows**: Tables connected through business cycles
    * Example: customers → invoices → payments (AR cycle)
    * Example: vendors → purchase_orders → invoices → payments (AP cycle)

  **IMPORTANT**: Be thorough in detecting relationships. Missing a relationship is worse than suggesting a low-confidence one. Consider:
  - Column name similarities (even partial matches)
  - Semantic similarity (customer vs client, product vs item)
  - Domain-specific patterns (txn_id, order_id, invoice_id often link tables)
  - Cardinality hints from distinct_count ratios

  ## Semantic Role Definitions

  - **key**: Primary identifier for the table (usually unique, non-null)
  - **foreign_key**: References another table's key
  - **measure**: Numeric value that can be aggregated (summed, averaged)
  - **dimension**: Categorical attribute for grouping/filtering
  - **timestamp**: Date or datetime for time-based analysis
  - **attribute**: Descriptive field, not typically used for aggregation or grouping

  ## Response Format

  Respond with valid JSON only, no markdown formatting:

  {{
    "tables": [
      {{
        "table_name": "...",
        "entity_type": "...",
        "description": "...",
        "is_fact_table": true,
        "grain": ["col1"],
        "time_column": "created_at",
        "columns": [
          {{
            "column_name": "...",
            "semantic_role": "key|foreign_key|measure|dimension|timestamp|attribute",
            "entity_type": "...",
            "business_term": "...",
            "description": "...",
            "confidence": 0.95
          }}
        ]
      }}
    ],
    "relationships": [
      {{
        "from_table": "transactions",
        "from_column": "customer_id",
        "to_table": "customers",
        "to_column": "id",
        "relationship_type": "foreign_key",
        "cardinality": "many_to_one",
        "confidence": 0.95,
        "reasoning": "customer_id in transactions references customers.id primary key"
      }}
    ],
    "summary": "Brief overview of the schema structure and domain"
  }}

# Input variable definitions
inputs:
  tables_json:
    description: JSON array of tables with columns and statistics
    required: true

  ontology_name:
    description: Name of the target ontology
    required: true
    default: "general"

  ontology_concepts:
    description: List of concepts from the ontology
    required: false
    default: "No specific ontology concepts defined"

# Expected output schema (for validation)
output_schema:
  type: object
  required:
    - tables
  properties:
    tables:
      type: array
      items:
        type: object
        required:
          - table_name
          - columns
    relationships:
      type: array
    summary:
      type: string

# Validation rules
validation:
  semantic_role_values:
    - measure
    - dimension
    - key
    - foreign_key
    - timestamp
    - attribute
  relationship_types:
    - foreign_key
    - hierarchy
  cardinality_values:
    - one_to_one
    - one_to_many
    - many_to_one
    - many_to_many
