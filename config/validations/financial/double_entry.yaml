# Double Entry Balance Validation
# Checks if debits equal credits (fundamental accounting principle)

validation_id: double_entry_balance
name: Double Entry Balance
description: >
  Validates that total debits equal total credits in the accounting data.
  This is a fundamental principle of double-entry bookkeeping where every
  transaction affects at least two accounts with equal and opposite effects.

category: financial
severity: critical
version: "1.0"

tags:
  - accounting
  - double-entry
  - balance
  - critical

check_type: balance

# Column requirements resolved via semantic annotations
column_requirements:
  # Primary: Look for separate debit/credit columns
  debit_amount:
    entity_type: debit
    name_patterns: ["debit", "dr", "debit_amount"]
    required: false  # Optional if using amount + account_type

  credit_amount:
    entity_type: credit
    name_patterns: ["credit", "cr", "credit_amount"]
    required: false

  # Alternative: Single amount with account type
  amount:
    semantic_role: measure
    entity_type: amount
    name_patterns: ["amount", "value", "balance"]
    required: false

  account_type:
    entity_type: account_type
    name_patterns: ["account_type", "account_category", "type", "category"]
    required: false

parameters:
  tolerance: 0.01  # Acceptable difference threshold

sql_hints: >
  Generate SQL that calculates total debits and total credits.
  If debit/credit columns exist: SUM(debit) vs SUM(credit).
  If only amount + account_type exist: classify by account_type where
  asset/expense types are typically debits and liability/equity/revenue are credits.
  Return columns: total_debits, total_credits, difference.

expected_outcome: >
  The difference between total debits and total credits should be
  within the tolerance threshold (0.01). If balanced, the check passes.
