# =============================================================================
# Days Sales Outstanding (DSO) Calculation Graph
# =============================================================================
# 
# Purpose: Calculate average number of days to collect payment after a sale
# 
# Formula: (Accounts Receivable / Revenue) × Days in Period
# 
# This is a fundamental working capital metric that measures collection efficiency.
# Lower DSO indicates faster cash collection and better working capital management.
# =============================================================================

graph_id: "dso"
version: "1.0"
category: "working_capital"
complexity: "simple"  # Single period calculation

metadata:
  created_by: "Dataraum Finance KB"
  last_updated: "2025-01-15"
  tested_with: ["datev_skr03", "datev_skr04", "standard_coa"]
  typical_execution_time_ms: 50
  also_known_as: ["days_sales_outstanding", "debtor_days", "collection_period"]

# =============================================================================
# Core Calculation Definition
# =============================================================================

output:
  metric_id: "dso"
  description: "Average number of days to collect payment after a sale"
  unit: "days"
  data_type: "float"
  decimal_places: 1

formula:
  human_readable: "(Accounts Receivable / Revenue) × Days in Period"
  mathematical: "DSO = (AR / R) × D"
  components:
    - "AR = Accounts Receivable (end of period)"
    - "R = Revenue for the period"
    - "D = Number of days in the period"

# =============================================================================
# Dependency Graph
# =============================================================================

dependencies:
  
  # Level 1: Base Data Inputs
  # -------------------------
  
  accounts_receivable:
    dependency_id: "accounts_receivable"
    level: 1
    type: "direct"
    description: "Outstanding customer receivables at end of period"
    
    source:
      statement: "balance_sheet"
      standard_field: "accounts_receivable"
      aggregation: "end_of_period"
      
    datev_mapping:
      skr03: 
        - 1200  # Forderungen aus Lieferungen und Leistungen (Trade receivables)
        - 1400  # Sonstige Vermögensgegenstände (Other receivables - if trade-related)
        - 1576  # Abziehbare Vorsteuer (VAT receivable on sales)
      skr04:
        - 1200  # Forderungen
        - 1400  # Sonstige Forderungen
        
    accounting_notes: |
      Should include:
      - Trade receivables from customers
      - Unbilled revenue / accrued income (if policy includes)
      
      Should EXCLUDE:
      - Employee advances
      - Related party receivables (unless operational)
      - Long-term receivables (> 1 year)
      - Allowance for doubtful accounts (use gross AR)
      
    validation:
      - check: "accounts_receivable IS NOT NULL"
        severity: "error"
        message: "Accounts receivable balance is required for DSO calculation"
      - check: "accounts_receivable >= 0"
        severity: "error"
        message: "Accounts receivable cannot be negative"
      - check: "accounts_receivable < (revenue * 2)"
        severity: "warning"
        message: "AR exceeds 2x period revenue - possible data quality issue"
        
    required: true
    nullable: false
    
  revenue:
    dependency_id: "revenue"
    level: 1
    type: "direct"
    description: "Total revenue for the period"
    
    source:
      statement: "income_statement"
      standard_field: "revenue"
      aggregation: "sum"
      period: "current"
      
    datev_mapping:
      skr03:
        - 4000  # Erlöse (Revenue)
        - 4120  # Erlöse 19% USt (Revenue with 19% VAT)
        - 4125  # Erlöse 7% USt (Revenue with 7% VAT)
        - 4300  # Erlöse aus Dienstleistungen (Service revenue)
        - 4400  # Erlöse 0% (Zero-rated revenue)
        - 4500  # Erlöse Ausland (Foreign revenue)
        - 4600  # Erlöse innergemeinschaftlich (Intra-EU revenue)
      skr04:
        - 5000  # Umsatzerlöse (Sales revenue)
        - 5400  # Erlöse 19% USt
        - 5600  # Erlöse 7% USt
        - 5700  # Umsatzerlöse Ausland
        - 5800  # Erlöse EU
        
    accounting_notes: |
      Should include:
      - All product revenue
      - All service revenue
      - Net of returns and discounts
      
      Should EXCLUDE:
      - Other income (non-operating)
      - Interest income
      - One-time gains
      
    validation:
      - check: "revenue IS NOT NULL"
        severity: "error"
        message: "Revenue is required for DSO calculation"
      - check: "revenue > 0"
        severity: "error"
        message: "Revenue must be positive for DSO calculation"
      - check: "revenue >= (accounts_receivable * 0.1)"
        severity: "warning"
        message: "Revenue seems low relative to AR - check period alignment"
        
    required: true
    nullable: false
    
  days_in_period:
    dependency_id: "days_in_period"
    level: 1
    type: "constant"
    description: "Number of days in the analysis period"
    
    default_value: 30  # Monthly analysis
    user_configurable: true
    
    validation:
      - check: "days_in_period > 0"
        severity: "error"
        message: "Days in period must be positive"
      - check: "days_in_period IN (30, 90, 365)"
        severity: "warning"
        message: "Non-standard period length - ensure consistent with revenue period"
        
    common_values:
      monthly: 30
      quarterly: 90
      annual: 365
      
    required: true
    nullable: false
    
  # Level 2: Scenario Parameters (Optional)
  # ----------------------------------------
  
  collection_improvement_days:
    dependency_id: "collection_improvement"
    level: 2
    type: "constant"
    description: "Scenario: Target DSO reduction in days (negative = improvement)"
    
    default_value: 0
    user_configurable: true
    
    validation:
      - check: "collection_improvement_days >= -90"
        severity: "warning"
        message: "90+ day DSO improvement may be unrealistic in single period"
        
    scenario_examples:
      base: 0           # Current state
      moderate_improvement: -5  # 5 days faster collection
      aggressive_improvement: -15  # 15 days faster
      deterioration: 10  # 10 days slower (risk scenario)
      
    required: false
    nullable: true

# =============================================================================
# SQL Generation Template
# =============================================================================

sql_template: |
  -- =========================================================================
  -- Days Sales Outstanding (DSO) Calculation
  -- Generated from calculation graph: dso_calculation_graph.yaml v1.0
  -- =========================================================================
  
  WITH parameters AS (
    SELECT 
      '{{current_period}}'::DATE as current_period,
      {{days_in_period}}::INT as days_in_period,
      {{collection_improvement_days}}::INT as scenario_adjustment
  ),
  
  balance_sheet_data AS (
    -- Get accounts receivable balance (Level 1 dependency)
    SELECT 
      p.current_period,
      COALESCE(bs.accounts_receivable, 0) as accounts_receivable,
      bs.accounts_receivable_gross,
      bs.allowance_for_doubtful_accounts
    FROM parameters p
    LEFT JOIN balance_sheet bs 
      ON bs.period = p.current_period
  ),
  
  income_statement_data AS (
    -- Get revenue for the period (Level 1 dependency)
    SELECT
      p.current_period,
      COALESCE(is_table.revenue, 0) as revenue,
      -- Optional: track credit vs cash sales if available
      is_table.credit_sales_percentage
    FROM parameters p
    LEFT JOIN income_statement is_table 
      ON is_table.period = p.current_period
  ),
  
  dso_calculation AS (
    -- Calculate DSO
    SELECT
      -- Input data
      bs.accounts_receivable,
      isd.revenue,
      p.days_in_period,
      
      -- Core DSO calculation
      CASE 
        WHEN isd.revenue > 0 THEN
          (bs.accounts_receivable / isd.revenue) * p.days_in_period
        ELSE 
          NULL  -- Cannot calculate DSO with zero revenue
      END as dso_days,
      
      -- Scenario-adjusted DSO (for what-if analysis)
      CASE 
        WHEN isd.revenue > 0 THEN
          ((bs.accounts_receivable / isd.revenue) * p.days_in_period) 
          + p.scenario_adjustment
        ELSE 
          NULL
      END as dso_days_scenario,
      
      -- Supporting metrics
      CASE 
        WHEN isd.revenue > 0 THEN
          bs.accounts_receivable / (isd.revenue / p.days_in_period)
        ELSE
          NULL
      END as collection_days_direct,
      
      -- AR turnover ratio (complementary metric)
      CASE 
        WHEN bs.accounts_receivable > 0 THEN
          isd.revenue / bs.accounts_receivable
        ELSE
          NULL
      END as ar_turnover_ratio,
      
      -- What would AR need to be for target DSO?
      CASE 
        WHEN isd.revenue > 0 AND p.scenario_adjustment != 0 THEN
          (isd.revenue / p.days_in_period) * 
          (((bs.accounts_receivable / isd.revenue) * p.days_in_period) + p.scenario_adjustment)
        ELSE
          bs.accounts_receivable
      END as target_ar_for_scenario,
      
      -- Metadata
      p.current_period,
      CURRENT_TIMESTAMP as calculated_at,
      p.scenario_adjustment,
      
      -- Data quality flags
      bs.accounts_receivable_gross,
      bs.allowance_for_doubtful_accounts,
      isd.credit_sales_percentage
      
    FROM balance_sheet_data bs
    CROSS JOIN income_statement_data isd
    CROSS JOIN parameters p
  )
  
  SELECT 
    -- Primary output
    dso_days,
    
    -- Scenario output (if applicable)
    CASE 
      WHEN scenario_adjustment != 0 THEN dso_days_scenario
      ELSE NULL
    END as dso_days_scenario,
    
    -- Supporting details
    accounts_receivable as current_ar,
    revenue as period_revenue,
    days_in_period,
    
    -- Derived metrics
    ar_turnover_ratio,
    ROUND(365.0 / NULLIF(ar_turnover_ratio, 0), 1) as annualized_dso,
    
    -- Interpretation helpers
    CASE 
      WHEN dso_days IS NULL THEN 'NO_REVENUE'
      WHEN dso_days <= 30 THEN 'EXCELLENT'
      WHEN dso_days <= 45 THEN 'GOOD'
      WHEN dso_days <= 60 THEN 'CONCERNING'
      WHEN dso_days <= 90 THEN 'POOR'
      ELSE 'CRITICAL'
    END as dso_status,
    
    -- Scenario analysis
    CASE 
      WHEN scenario_adjustment != 0 THEN
        target_ar_for_scenario - accounts_receivable
      ELSE NULL
    END as ar_change_needed_for_scenario,
    
    CASE 
      WHEN scenario_adjustment != 0 THEN
        ((target_ar_for_scenario - accounts_receivable) / 
         NULLIF(accounts_receivable, 0)) * 100
      ELSE NULL
    END as ar_change_percentage_for_scenario,
    
    -- Data quality
    accounts_receivable_gross,
    allowance_for_doubtful_accounts,
    credit_sales_percentage,
    
    -- Metadata
    current_period,
    calculated_at,
    scenario_adjustment as collection_improvement_scenario_days,
    
    -- Hash for reproducibility
    MD5(
      CONCAT(
        current_period::TEXT, '|',
        days_in_period::TEXT, '|',
        scenario_adjustment::TEXT
      )
    ) as calculation_hash
    
  FROM dso_calculation;

# =============================================================================
# Validation Rules (Pre-execution checks)
# =============================================================================

pre_execution_validations:
  
  - validation_id: "ar_balance_exists"
    check: "SELECT COUNT(*) FROM balance_sheet WHERE period = '{{current_period}}' AND accounts_receivable IS NOT NULL"
    expected: "> 0"
    severity: "error"
    message: "No accounts receivable balance found for current period"
    
  - validation_id: "revenue_exists"
    check: "SELECT COUNT(*) FROM income_statement WHERE period = '{{current_period}}' AND revenue IS NOT NULL"
    expected: "> 0"
    severity: "error"
    message: "No revenue data found for current period"
    
  - validation_id: "revenue_positive"
    check: "SELECT revenue > 0 FROM income_statement WHERE period = '{{current_period}}'"
    expected: "true"
    severity: "error"
    message: "Revenue must be positive for DSO calculation"
    
  - validation_id: "ar_not_negative"
    check: "SELECT accounts_receivable >= 0 FROM balance_sheet WHERE period = '{{current_period}}'"
    expected: "true"
    severity: "error"
    message: "Accounts receivable cannot be negative"
    
  - validation_id: "ar_revenue_ratio_sanity"
    check: |
      SELECT (bs.accounts_receivable / is_table.revenue) <= 3
      FROM balance_sheet bs
      JOIN income_statement is_table ON is_table.period = bs.period
      WHERE bs.period = '{{current_period}}'
    expected: "true"
    severity: "warning"
    message: "AR exceeds 3x monthly revenue - possible data quality issue or very long collection cycle"

# =============================================================================
# Post-execution validations (Result sanity checks)
# =============================================================================

post_execution_validations:
  
  - validation_id: "dso_reasonable_range"
    check: "dso_days BETWEEN 0 AND 365"
    severity: "warning"
    message: "DSO outside reasonable range (0-365 days)"
    
  - validation_id: "dso_not_null_with_revenue"
    check: "dso_days IS NOT NULL OR period_revenue = 0"
    severity: "error"
    message: "DSO calculation failed despite positive revenue"

# =============================================================================
# Interpretation Guide
# =============================================================================

interpretation:
  
  ranges:
    excellent:
      min: 0
      max: 30
      context: "Very efficient collection - typical for cash/COD businesses"
      
    good:
      min: 31
      max: 45
      context: "Strong collection performance - industry standard for B2B"
      
    concerning:
      min: 46
      max: 60
      context: "Slower than ideal - review collection processes"
      
    poor:
      min: 61
      max: 90
      context: "Significant working capital tied up - action needed"
      
    critical:
      min: 91
      max: 999
      context: "Major collection issues - urgent intervention required"
  
  context: |
    Days Sales Outstanding (DSO) measures the average time to collect payment
    after a sale. Lower DSO indicates:
    - Faster cash conversion
    - Better working capital management
    - Lower credit risk
    - Reduced need for external financing
    
    Factors affecting DSO:
    - Payment terms offered to customers (net 30, net 60, etc.)
    - Industry norms (B2B typically 30-60 days, retail 0-15 days)
    - Customer credit quality
    - Collection efficiency
    - Seasonal variations
    
  actionable_insights:
    excellent:
      - "Maintain current collection practices"
      - "Consider if aggressive collection impacts customer satisfaction"
      - "May have opportunity to extend terms for competitive advantage"
      
    good:
      - "Monitor for seasonal variations"
      - "Benchmark against top performers in industry"
      - "Continue current practices"
      
    concerning:
      - "Review credit policies and approval processes"
      - "Implement aging reports and collection follow-ups"
      - "Consider early payment discounts (2/10 net 30)"
      - "Evaluate customer credit quality"
      
    poor:
      - "Immediate review of collection procedures"
      - "Implement weekly AR aging review"
      - "Consider factoring or AR financing"
      - "Review payment terms with major customers"
      - "Assess if product/service quality issues delaying payment"
      
    critical:
      - "Crisis mode - daily collection focus"
      - "Evaluate customer solvency"
      - "Consider legal collection action"
      - "Require deposits or COD for new orders"
      - "Review allowance for doubtful accounts"
  
  improvement_strategies:
    - strategy: "Invoice immediately upon delivery"
      impact_days: -5
      difficulty: "easy"
      
    - strategy: "Implement electronic invoicing"
      impact_days: -3
      difficulty: "easy"
      
    - strategy: "Offer early payment discount (2/10 net 30)"
      impact_days: -7
      difficulty: "medium"
      cost: "2% revenue discount for early payers"
      
    - strategy: "Automate payment reminders"
      impact_days: -5
      difficulty: "medium"
      
    - strategy: "Tighten credit approval criteria"
      impact_days: -10
      difficulty: "hard"
      tradeoff: "May reduce sales volume"
      
    - strategy: "Shorten payment terms (net 30 → net 15)"
      impact_days: -15
      difficulty: "hard"
      tradeoff: "May face customer pushback"
      
  comparative_analysis:
    year_over_year: "Compare DSO to same period last year"
    month_over_month: "Track monthly trend to identify deterioration early"
    peer_benchmark: "Compare to industry average for context"
    cohort_analysis: "Track DSO by customer segment or product line"

# =============================================================================
# Industry Benchmarks
# =============================================================================

industry_benchmarks:
  
  saas:
    typical_dso: 45
    best_in_class: 30
    notes: "Monthly/annual subscriptions collected upfront; DSO should be low"
    
  manufacturing:
    typical_dso: 60
    best_in_class: 45
    notes: "Net 30-60 payment terms common; longer for large enterprise customers"
    
  wholesale_distribution:
    typical_dso: 45
    best_in_class: 35
    notes: "Net 30 standard; volume customers may negotiate longer terms"
    
  professional_services:
    typical_dso: 60
    best_in_class: 45
    notes: "Project-based billing; milestone payments can extend DSO"
    
  retail:
    typical_dso: 10
    best_in_class: 5
    notes: "High cash/credit card sales; B2B component increases DSO"
    
  construction:
    typical_dso: 75
    best_in_class: 60
    notes: "Progress billing and retention holdbacks extend collection period"
    
  healthcare:
    typical_dso: 50
    best_in_class: 35
    notes: "Insurance reimbursement delays; government payers slowest"

# =============================================================================
# Related Metrics (for comprehensive analysis)
# =============================================================================

related_metrics:
  
  - metric_id: "dpo"
    name: "Days Payable Outstanding"
    relationship: "Together with DSO and DIO, forms Cash Conversion Cycle"
    
  - metric_id: "collection_effectiveness_index"
    name: "Collection Effectiveness Index (CEI)"
    formula: "((Beginning AR + Period Sales - Ending AR) / (Beginning AR + Period Sales - Ending Current AR)) × 100"
    
  - metric_id: "best_possible_dso"
    name: "Best Possible DSO"
    formula: "(Current AR / Credit Sales) × Days"
    notes: "Excludes AR that isn't yet due - shows best achievable DSO"
    
  - metric_id: "ar_aging"
    name: "AR Aging Analysis"
    relationship: "Detailed breakdown of DSO by age bucket (0-30, 31-60, 61-90, 90+)"

# =============================================================================
# Testing & Examples
# =============================================================================

test_cases:
  
  - test_id: "typical_b2b"
    description: "Typical B2B company with net 30 terms"
    input:
      accounts_receivable: 100000
      revenue: 60000
      days_in_period: 30
      collection_improvement_days: 0
    expected_output:
      dso_days: 50.0
      dso_status: "CONCERNING"
      ar_turnover_ratio: 0.6
      
  - test_id: "saas_company"
    description: "SaaS company with upfront annual billing"
    input:
      accounts_receivable: 50000
      revenue: 100000
      days_in_period: 30
      collection_improvement_days: 0
    expected_output:
      dso_days: 15.0
      dso_status: "EXCELLENT"
      ar_turnover_ratio: 2.0
      
  - test_id: "improvement_scenario"
    description: "What if we improve collection by 10 days?"
    input:
      accounts_receivable: 150000
      revenue: 90000
      days_in_period: 30
      collection_improvement_days: -10
    expected_output:
      dso_days: 50.0
      dso_days_scenario: 40.0
      target_ar_for_scenario: 120000
      ar_change_needed_for_scenario: -30000
      ar_change_percentage_for_scenario: -20.0
      
  - test_id: "deterioration_scenario"
    description: "Risk scenario: collection slows by 15 days"
    input:
      accounts_receivable: 80000
      revenue: 60000
      days_in_period: 30
      collection_improvement_days: 15
    expected_output:
      dso_days: 40.0
      dso_days_scenario: 55.0
      target_ar_for_scenario: 110000
      ar_change_needed_for_scenario: 30000

# =============================================================================
# Common Issues & Troubleshooting
# =============================================================================

common_issues:
  
  - issue: "DSO trending upward"
    possible_causes:
      - "Relaxed credit policies"
      - "Customer financial difficulties"
      - "Inadequate collection follow-up"
      - "Disputed invoices/service issues"
      - "Seasonal factors"
      - "Customer mix shift to slower payers"
    diagnostic_queries:
      - "SELECT customer_id, AVG(days_to_pay) FROM ar_aging GROUP BY customer_id ORDER BY 2 DESC LIMIT 10"
      - "SELECT period, AVG(dso_days) FROM dso_history GROUP BY period ORDER BY period"
      
  - issue: "DSO much higher than payment terms"
    possible_causes:
      - "Customers not adhering to terms"
      - "Invoice disputes"
      - "Poor collection processes"
    action: "Implement AR aging analysis by customer"
    
  - issue: "DSO volatile month-to-month"
    possible_causes:
      - "Lumpy revenue (large invoices)"
      - "Seasonal business patterns"
      - "Inconsistent billing timing"
    action: "Use rolling 3-month average DSO for trend analysis"
    
  - issue: "DSO calculation seems wrong"
    possible_causes:
      - "Period mismatch (monthly AR vs quarterly revenue)"
      - "AR includes non-trade receivables"
      - "Revenue includes non-credit sales"
    action: "Verify AR and revenue are from same period and definition"

# =============================================================================
# Change Log
# =============================================================================

changelog:
  - version: "1.0"
    date: "2025-01-15"
    changes:
      - "Initial DSO calculation graph definition"
      - "Added scenario analysis for collection improvement"
      - "Defined DATEV SKR03/SKR04 mappings"
      - "Added comprehensive validation rules"
      - "Included industry benchmarks"
      - "Added related metrics and improvement strategies"
